#!/bin/bash

###########################
#(C) Will Cunningham 2014 #
#         DK Lab          #
# Northeastern University #
###########################

set -eu -o pipefail

# NOTE: The variable used for spacetime may change, and should be cross-referenced with doc/VERSION.
# The current version is indicated in the file inc/Constants.h

####################################
# Examples of How to Use CausalSet #
####################################

# 1+1 flat Minkowski diamond
#./bin/CausalSet --spacetime 11274 --nodes 1000 --age 0.5 --link --print

# 1+1 de Sitter, spherical foliation
#./bin/CausalSet --spacetime 12834 --nodes 24586 --age 1.5707577 --link --print

# 3+1 de Sitter, spherical foliation
#./bin/CausalSet --spacetime 12836 --nodes 65536 --age 1.2 --buffer 0.3 --link --gpu --print

# 3+1 de Sitter, flat foliation
#./bin/CausalSet --spacetime 10788 --nodes 122880 --age 0.848152 --slice 4.9997 --buffer 0.3 --link --gpu --print

# 3+1 Dust, flat foliation
#./bin/CausalSet --spacetime 10820 --nodes 65536 --age 0.848152 --alpha 5 --link --gpu --print

# 3+1 FLRW, flat foliation
#./bin/CausalSet --spacetime 10884 --nodes 10240 --energy 0.7 --alpha 3 --link --gpu --print

# 1+1 Hyperbolic, reading file 'dat/pos/321.cset.pos.dat'
#./bin/CausalSet --graph 321 --dim 1 --manifold h --relink --print

########################
# The Validation Tests #
########################

# de Sitter Embedding
#./bin/CausalSet --spacetime 12836 --nodes 20480 --age 1.5 --seed 18100 --buffer 0.3 --link --gpu --embedding 1

# de Sitter Distances
#./bin/CausalSet --spacetime 12836 --nodes 2048 --age 1.2 --seed 18100 --buffer 0.3 --link --gpu --distances 100

#####################################
# These are experimental parameters #
#####################################

test_action=true
if [[ $test_action == "false" ]] ; then
  platform="_par-gpu-2"
  num=1000000
  zeta=1

  exp="hyp_static"
  measure=""
  #measure="--components"
  #measure="--success 16384"
  #measure="--vecprod 0.1"

  if [[ $exp == "hyp_static" ]] ; then
    #$CAUSET_HOME_DIR/bin/CausalSet$platform --spacetime 50332034 --nodes $num --radius 18.5 --zeta $zeta --verbose -y --link --core 1 --gpu $measure #--print
    $CAUSET_HOME_DIR/bin/CausalSet$platform --spacetime 50332034 --nodes $num --radius 30 --zeta $zeta --verbose --link --gpu $measure #--print
  elif [[ $exp == "hyp_growing" ]] ; then
    $CAUSET_HOME_DIR/bin/CausalSet$platform --spacetime 49922 --nodes $num --radius 23.5 --zeta $zeta --verbose -y --growing --link --core 1 --gpu $measure #--print
  elif [[ $exp == "epso" ]] ; then
    $CAUSET_HOME_DIR/bin/CausalSet$platform --spacetime 49922 --nodes $num --radius 22.5 --zeta $zeta --verbose -y --growing --link --link-epso --core 1 --gpu $measure #--print
  elif [[ $exp == "de_sitter" ]] ; then
    $CAUSET_HOME_DIR/bin/CausalSet$platform --spacetime 82466 --nodes $num --age 1.570784 --verbose -y --link --core 1 --gpu $measure #--print
    #$CAUSET_HOME_DIR/bin/CausalSet$platform --spacetime 41508 --nodes $num --age 1.5 --radius 4 --verbose -y --link --core 0.99 --gpu $measure #--print
  fi
else
  platform=_krioukov_gpu
  #spacetime=83886356 # 3+1 de Sitter Slab
  spacetime=75497738 # 1+1 Minkowski Slab
  #spacetime=75759626 # 1+1 Minkowski Saucer
  #spacetime=76021770 # 1+1 Minkowski Saucer (T)
  #spacetime=75499530 # 1+1 Minkowski Slab (S)
  #spacetime=75497994 # 1+1 Minkowski Slab (T)
  #spacetime=76546058 # 1+1 Minkowski Triangle (T)
  age=0.25
  num=10240
  cutoff=0.75
  np=4
  makenew=true

  if [[ "$makenew" == "true" ]] ; then
    #mpirun -np $np -prot -hostfile $CAUSET_HOME_DIR/hostfile \
    $CAUSET_HOME_DIR/bin/CausalSet${platform} --spacetime $spacetime --nodes $num --age $age --radius $cutoff --verbose -y --link --gpu --core 1 --action smeared #--print --print-edges
  else
    graphs=($(awk '{print $1}' $CAUSET_HOME_DIR/etc/data_keys.cset.key))
    graph=${graphs[${#graphs[@]}-1]}
    #graph=111
    #mpirun -np $np -prot -hostfile hostfile \
    $CAUSET_HOME_DIR/bin/CausalSet${platform} --spacetime $spacetime --age $age --radius $cutoff --graph $graph --core 1 --verbose -y --action smeared --relink 
  fi
fi

######################################
# These will reproduce known results #
######################################

# Generate causal set for 1+1 de Sitter (no matter)
#./bin/CausalSet --spacetime 12834 --nodes 24586 --age 1.5707577 --seed 18100 --link --print
# Should find k = 5.53, gamma = 2

# Generate causal set for 3+1 de Sitter (no matter)
#./bin/CausalSet --spacetime 12836 --nodes 25441 --age 1.5296963 --seed 18100 --buffer 0.3 --link --print
# Should find k = 5.29, gamma = 1.75

# Generate causal set for FLRW universe (mix of dark energy and matter)
#./bin/CausalSet --spacetime 12932 --nodes 1000887 --age 0.8458 --alpha 2.01 --delta 10000 --seed 18100 --link --gpu --verbose -y --print &> causet.log &
# Should find k = 727, in-degree given by Fig. (S3), out-degree given by Fig. (3a)
# Note this takes ~ 3.5 days to run without the GPU!!!

# Read hyperbolic graph data and perform greedy routing algorithm
#./bin/CausalSet --spacetime 11010 --graph 321 --seed 18100 --verbose -y --success 1
# Should find a success ratio of 1.0 and a single connected component

# Compare to Dima's Fortran Code
# Make sure to manually alter parameters in fortran code and re-compile!
#./bin/CausalSet --spacetime 12932 --graph 22222 --nodes 10240 --age 1.5 --delta 1 --link --gpu --components
#./etc/dk_stats_direct.pl 22222
